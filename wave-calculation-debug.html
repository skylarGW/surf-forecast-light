<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµªé«˜è®¡ç®—æ­¥éª¤è°ƒè¯•å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; }
        .debug-card { 
            background: white; 
            border-radius: 8px; 
            padding: 20px; 
            margin: 20px 0; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .step { 
            background: #f8f9fa; 
            border-left: 4px solid #007bff; 
            padding: 15px; 
            margin: 10px 0; 
        }
        .calculation { 
            background: #e7f3ff; 
            padding: 10px; 
            border-radius: 5px; 
            font-family: monospace; 
            margin: 10px 0;
        }
        .result { 
            background: #d4edda; 
            color: #155724; 
            padding: 10px; 
            border-radius: 5px; 
            font-weight: bold;
        }
        .original { 
            background: #fff3cd; 
            color: #856404; 
            padding: 10px; 
            border-radius: 5px; 
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 10px 5px;
        }
        button:hover { background: #0056b3; }
        .factor { color: #dc3545; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æµªé«˜è®¡ç®—æ­¥éª¤è°ƒè¯•å·¥å…·</h1>
        <p>è¯¦ç»†å±•ç¤ºä»APIåŸå§‹æ•°æ®åˆ°ç½‘ç«™æ˜¾ç¤ºæ•°æ®çš„å®Œæ•´è®¡ç®—è¿‡ç¨‹</p>
        
        <div>
            <button onclick="debugHainanSpot()">è°ƒè¯•æµ·å—é™µæ°´ä¸‡è±ª</button>
            <button onclick="debugQingdaoSpot()">è°ƒè¯•é’å²›çŸ³è€äºº</button>
            <button onclick="debugZhoushanSpot()">è°ƒè¯•èˆŸå±±ä¸œæ²™</button>
            <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script src="js/windy-service.js"></script>
    <script>
        // æµªç‚¹é…ç½®
        const debugSpots = {
            hainan: { 
                name: "æµ·å—-é™µæ°´ä¸‡è±ª", 
                lat: 18.527192, 
                lng: 110.107462,
                bayShape: "open", 
                seabedType: "sand" 
            },
            qingdao: { 
                name: "é’å²›-çŸ³è€äºº", 
                lat: 36.088937, 
                lng: 120.46526,
                bayShape: "open", 
                seabedType: "sand" 
            },
            zhoushan: { 
                name: "èˆŸå±±-ä¸œæ²™", 
                lat: 30.0444, 
                lng: 122.1067,
                bayShape: "enclosed", 
                seabedType: "sand" 
            }
        };

        // æ ¡å‡†å‚æ•°
        const calibrationFactors = {
            terrain: { open: 0.9, enclosed: 0.4 },
            seabedType: { sand: 0.7, sand_rock: 0.75, rock: 0.85, reef: 0.9, rock_reef: 0.8, sand_reef: 0.75 },
            energy: 0.9
        };



        // æ ¡å‡†å‡½æ•°
        function calibrateWaveHeight(baseWave, spot) {
            const steps = [];
            let calibrated = baseWave;
            
            steps.push({
                step: "åŸå§‹æ•°æ®",
                value: baseWave,
                description: "APIè¿”å›çš„åŸå§‹æµªé«˜"
            });
            
            const terrainFactor = calibrationFactors.terrain[spot.bayShape];
            calibrated *= terrainFactor;
            steps.push({
                step: "åœ°å½¢æ ¡å‡†",
                factor: terrainFactor,
                value: calibrated,
                description: `${spot.bayShape} åœ°å½¢å½±å“`
            });
            
            const seabedFactor = calibrationFactors.seabedType[spot.seabedType];
            calibrated *= seabedFactor;
            steps.push({
                step: "æµ·åºŠæ ¡å‡†", 
                factor: seabedFactor,
                value: calibrated,
                description: `${spot.seabedType} æµ·åºŠç±»å‹å½±å“`
            });
            
            const energyFactor = calibrationFactors.energy;
            calibrated *= energyFactor;
            steps.push({
                step: "èƒ½é‡è¡°å‡",
                factor: energyFactor,
                value: calibrated,
                description: "æµ·æµªèƒ½é‡è‡ªç„¶è¡°å‡"
            });
            
            const finalValue = Math.round(Math.max(0.3, calibrated) * 100) / 100;
            steps.push({
                step: "æœ€ç»ˆç»“æœ",
                value: finalValue,
                description: "å››èˆäº”å…¥å¹¶è®¾ç½®æœ€å°å€¼0.3m"
            });
            
            return { finalValue, steps };
        }

        async function debugSpot(spotKey) {
            const spot = debugSpots[spotKey];
            const resultsDiv = document.getElementById('results');
            
            // æ·»åŠ åŠ è½½çŠ¶æ€
            const loadingCard = document.createElement('div');
            loadingCard.className = 'debug-card';
            loadingCard.innerHTML = `
                <h3>${spot.name} - è®¡ç®—æ­¥éª¤åˆ†æ</h3>
                <div>æ­£åœ¨è·å–æ•°æ®å’Œè®¡ç®—...</div>
            `;
            resultsDiv.appendChild(loadingCard);

            try {
                // è·å–APIæ•°æ®
                const data = await windyService.getWaveData(spot.lat, spot.lng);
                console.log('Raw API data:', data);
                
                // ç§»é™¤åŠ è½½çŠ¶æ€
                resultsDiv.removeChild(loadingCard);
                
                if (data && data.forecast && data.forecast.length > 0) {
                    const forecast = data.forecast[0]; // ä½¿ç”¨ç¬¬ä¸€ä¸ªé¢„æµ‹ç‚¹
                    
                    // è®¡ç®—æ¯ä¸ªæµªé«˜åˆ†é‡çš„æ ¡å‡†æ­¥éª¤
                    const totalCalc = calibrateWaveHeight(forecast.totalWaveHeight || forecast.waveHeight, spot);
                    const windCalc = calibrateWaveHeight(forecast.windWaveHeight || forecast.totalWaveHeight * 0.5, spot);
                    const swellCalc = calibrateWaveHeight(forecast.swellHeight || forecast.totalWaveHeight * 0.4, spot);
                    
                    // æ˜¾ç¤ºç»“æœ
                    const resultCard = document.createElement('div');
                    resultCard.className = 'debug-card';
                    
                    let html = `
                        <h3>${spot.name} - è¯¦ç»†è®¡ç®—æ­¥éª¤</h3>
                        
                        <div class="step">
                            <h4>æµªç‚¹é…ç½®ä¿¡æ¯</h4>
                            <table>
                                <tr><th>å‚æ•°</th><th>å€¼</th><th>æ ¡å‡†å› å­</th></tr>
                                <tr><td>åœ°å½¢ç±»å‹</td><td>${spot.bayShape}</td><td class="factor">${calibrationFactors.terrain[spot.bayShape]}</td></tr>
                                <tr><td>æµ·åºŠç±»å‹</td><td>${spot.seabedType}</td><td class="factor">${calibrationFactors.seabedType[spot.seabedType]}</td></tr>
                                <tr><td>èƒ½é‡è¡°å‡</td><td>å›ºå®šå€¼</td><td class="factor">${calibrationFactors.energy}</td></tr>
                            </table>
                        </div>

                        <div class="step">
                            <h4>APIåŸå§‹æ•°æ®</h4>
                            <div class="original">
                                æ€»æµªé«˜: ${forecast.totalWaveHeight || forecast.waveHeight}m<br>
                                é£æµªåˆ†é‡: ${forecast.windWaveHeight || 'N/A'}m<br>
                                æ¶Œæµªåˆ†é‡: ${forecast.swellHeight || 'N/A'}m<br>
                                æ•°æ®æº: ${forecast.source}
                            </div>
                        </div>
                    `;
                    
                    // æ€»æµªé«˜è®¡ç®—æ­¥éª¤
                    html += `
                        <div class="step">
                            <h4>ğŸŒŠ æ€»æµªé«˜è®¡ç®—æ­¥éª¤</h4>
                            ${totalCalc.steps.map((step, index) => `
                                <div class="calculation">
                                    ${index + 1}. ${step.step}: 
                                    ${step.factor ? `${step.value.toFixed(4)}m (Ã—${step.factor})` : `${step.value.toFixed(4)}m`}
                                    <br><small>${step.description}</small>
                                </div>
                            `).join('')}
                            <div class="result">æœ€ç»ˆæ€»æµªé«˜: ${totalCalc.finalValue}m</div>
                        </div>
                    `;
                    
                    // é£æµªåˆ†é‡è®¡ç®—æ­¥éª¤
                    html += `
                        <div class="step">
                            <h4>ğŸ’¨ é£æµªåˆ†é‡è®¡ç®—æ­¥éª¤</h4>
                            ${windCalc.steps.map((step, index) => `
                                <div class="calculation">
                                    ${index + 1}. ${step.step}: 
                                    ${step.factor ? `${step.value.toFixed(4)}m (Ã—${step.factor})` : `${step.value.toFixed(4)}m`}
                                    <br><small>${step.description}</small>
                                </div>
                            `).join('')}
                            <div class="result">æœ€ç»ˆé£æµªåˆ†é‡: ${windCalc.finalValue}m</div>
                        </div>
                    `;
                    
                    // æ¶Œæµªåˆ†é‡è®¡ç®—æ­¥éª¤
                    html += `
                        <div class="step">
                            <h4>ğŸŒ€ æ¶Œæµªåˆ†é‡è®¡ç®—æ­¥éª¤</h4>
                            ${swellCalc.steps.map((step, index) => `
                                <div class="calculation">
                                    ${index + 1}. ${step.step}: 
                                    ${step.factor ? `${step.value.toFixed(4)}m (Ã—${step.factor})` : `${step.value.toFixed(4)}m`}
                                    <br><small>${step.description}</small>
                                </div>
                            `).join('')}
                            <div class="result">æœ€ç»ˆæ¶Œæµªåˆ†é‡: ${swellCalc.finalValue}m</div>
                        </div>
                    `;
                    
                    // æ€»ç»“å¯¹æ¯”
                    const totalReduction = ((forecast.totalWaveHeight - totalCalc.finalValue) / forecast.totalWaveHeight * 100).toFixed(1);
                    html += `
                        <div class="step">
                            <h4>ğŸ“Š æ•°æ®å¯¹æ¯”æ€»ç»“</h4>
                            <table>
                                <tr><th>æ•°æ®ç±»å‹</th><th>APIåŸå§‹å€¼</th><th>ç½‘ç«™æ˜¾ç¤ºå€¼</th><th>é™å¹…</th></tr>
                                <tr>
                                    <td>æ€»æµªé«˜</td>
                                    <td>${forecast.totalWaveHeight || forecast.waveHeight}m</td>
                                    <td>${totalCalc.finalValue}m</td>
                                    <td class="factor">${totalReduction}%</td>
                                </tr>
                                <tr>
                                    <td>é£æµªåˆ†é‡</td>
                                    <td>${forecast.windWaveHeight || (forecast.totalWaveHeight * 0.5).toFixed(2)}m</td>
                                    <td>${windCalc.finalValue}m</td>
                                    <td class="factor">${(((forecast.windWaveHeight || forecast.totalWaveHeight * 0.5) - windCalc.finalValue) / (forecast.windWaveHeight || forecast.totalWaveHeight * 0.5) * 100).toFixed(1)}%</td>
                                </tr>
                                <tr>
                                    <td>æ¶Œæµªåˆ†é‡</td>
                                    <td>${forecast.swellHeight || (forecast.totalWaveHeight * 0.4).toFixed(2)}m</td>
                                    <td>${swellCalc.finalValue}m</td>
                                    <td class="factor">${(((forecast.swellHeight || forecast.totalWaveHeight * 0.4) - swellCalc.finalValue) / (forecast.swellHeight || forecast.totalWaveHeight * 0.4) * 100).toFixed(1)}%</td>
                                </tr>
                            </table>
                        </div>
                    `;
                    
                    resultCard.innerHTML = html;
                    resultsDiv.appendChild(resultCard);
                    
                } else {
                    throw new Error('æœªè·å–åˆ°æœ‰æ•ˆæ•°æ®');
                }
                
            } catch (error) {
                console.error('Debug error:', error);
                
                if (resultsDiv.contains(loadingCard)) {
                    resultsDiv.removeChild(loadingCard);
                }
                
                const errorCard = document.createElement('div');
                errorCard.className = 'debug-card';
                errorCard.innerHTML = `
                    <h3>${spot.name}</h3>
                    <div style="color: #dc3545;">é”™è¯¯: ${error.message}</div>
                `;
                resultsDiv.appendChild(errorCard);
            }
        }

        function debugHainanSpot() {
            debugSpot('hainan');
        }

        function debugQingdaoSpot() {
            debugSpot('qingdao');
        }

        function debugZhoushanSpot() {
            debugSpot('zhoushan');
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºè¯´æ˜
        document.addEventListener('DOMContentLoaded', function() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="debug-card">
                    <h3>ğŸ” è®¡ç®—æ­¥éª¤è¯´æ˜</h3>
                    <p>æ­¤å·¥å…·è¯¦ç»†å±•ç¤ºæµªé«˜æ•°æ®ä»APIåŸå§‹å€¼åˆ°ç½‘ç«™æ˜¾ç¤ºå€¼çš„å®Œæ•´è®¡ç®—è¿‡ç¨‹ï¼š</p>
                    <ol>
                        <li><strong>APIåŸå§‹æ•°æ®</strong> - Windy APIè¿”å›çš„æœªå¤„ç†æµªé«˜å€¼</li>
                        <li><strong>åœ°å½¢æ ¡å‡†</strong> - æ ¹æ®æµ·æ¹¾å½¢çŠ¶è°ƒæ•´ (å¼€æ”¾0.9/å°é—­0.4)</li>
                        <li><strong>æµ·åºŠæ ¡å‡†</strong> - æ ¹æ®æµ·åºŠç±»å‹è°ƒæ•´ (æ²™/å²©çŸ³/çŠç‘šç¤ç­‰)</li>
                        <li><strong>èƒ½é‡è¡°å‡</strong> - è€ƒè™‘æµ·æµªä¼ æ’­è¿‡ç¨‹ä¸­çš„èƒ½é‡æŸå¤±</li>
                        <li><strong>æœ€ç»ˆç»“æœ</strong> - å››èˆäº”å…¥å¹¶è®¾ç½®æœ€å°å€¼é™åˆ¶</li>
                    </ol>
                    <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æŸ¥çœ‹å…·ä½“æµªç‚¹çš„è¯¦ç»†è®¡ç®—è¿‡ç¨‹ã€‚</p>
                </div>
            `;
        });
    </script>
</body>
</html>