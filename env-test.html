<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¯å¢ƒå˜é‡æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        .result { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 4px; }
        .error { background: #ffe6e6; color: #d00; }
        .success { background: #e6ffe6; color: #080; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto; }
        .highlight { background: #ffff99; padding: 2px 4px; }
    </style>
</head>
<body>
    <h1>ğŸ” ç¯å¢ƒå˜é‡è¯Šæ–­</h1>
    
    <div class="section">
        <h2>æ£€æŸ¥WINDY_API_KEYç¯å¢ƒå˜é‡</h2>
        <button onclick="testEnvironment()">æ£€æŸ¥ç¯å¢ƒå˜é‡</button>
        <div id="env-result" class="result"></div>
    </div>

    <script>
        function log(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<pre>${message}</pre>`;
            element.className = `result ${type}`;
        }

        async function testEnvironment() {
            try {
                console.log('å¼€å§‹ç¯å¢ƒå˜é‡æµ‹è¯•...');
                
                const response = await fetch('/api/env-test', {
                    method: 'GET'
                });
                
                const responseText = await response.text();
                console.log('ç¯å¢ƒæµ‹è¯•å“åº”:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`JSONè§£æå¤±è´¥: ${parseError.message}\nåŸå§‹å“åº”: ${responseText}`);
                }
                
                if (data.success) {
                    const env = data.environment;
                    let message = `=== ç¯å¢ƒå˜é‡è¯Šæ–­ç»“æœ ===\n\n`;
                    
                    message += `æ€»ç¯å¢ƒå˜é‡æ•°: ${env.totalEnvVars}\n`;
                    message += `Windyç›¸å…³å˜é‡: ${JSON.stringify(env.windyRelatedVars, null, 2)}\n\n`;
                    
                    message += `=== WINDY_API_KEY æ£€æŸ¥ ===\n`;
                    message += `å­˜åœ¨: ${env.windyApiKeyExists}\n`;
                    message += `é•¿åº¦: ${env.windyApiKeyLength}\n`;
                    message += `é¢„è§ˆ: ${env.windyApiKeyPreview || 'N/A'}\n\n`;
                    
                    message += `=== å¯èƒ½çš„å˜é‡åå˜ä½“ ===\n`;
                    const variants = env.possibleVariants;
                    if (Object.keys(variants).length > 0) {
                        Object.entries(variants).forEach(([name, info]) => {
                            message += `${name}: å­˜åœ¨ (é•¿åº¦: ${info.length}, é¢„è§ˆ: ${info.firstChars})\n`;
                        });
                    } else {
                        message += `æœªæ‰¾åˆ°ä»»ä½•WINDY_API_KEYå˜ä½“\n`;
                    }
                    
                    message += `\n=== ç¯å¢ƒä¿¡æ¯ ===\n`;
                    message += `NODE_ENV: ${env.nodeEnv || 'undefined'}\n`;
                    message += `VERCEL_ENV: ${env.vercelEnv || 'undefined'}\n`;
                    message += `æ—¶é—´æˆ³: ${env.timestamp}\n`;
                    
                    // åˆ¤æ–­é—®é¢˜ç±»å‹
                    let resultType = 'success';
                    if (!env.windyApiKeyExists) {
                        message += `\nâŒ é—®é¢˜è¯Šæ–­: WINDY_API_KEY ç¯å¢ƒå˜é‡ä¸å­˜åœ¨\n`;
                        message += `\nğŸ”§ è§£å†³æ–¹æ¡ˆ:\n`;
                        message += `1. ç™»å½• Vercel æ§åˆ¶å°\n`;
                        message += `2. è¿›å…¥é¡¹ç›® Settings > Environment Variables\n`;
                        message += `3. æ·»åŠ  WINDY_API_KEY ç¯å¢ƒå˜é‡\n`;
                        message += `4. ç¡®ä¿ Environment è®¾ç½®ä¸º "Production"\n`;
                        message += `5. é‡æ–°éƒ¨ç½²é¡¹ç›®\n`;
                        resultType = 'error';
                    } else if (env.windyApiKeyLength < 10) {
                        message += `\nâš ï¸ é—®é¢˜è¯Šæ–­: WINDY_API_KEY é•¿åº¦å¼‚å¸¸ (${env.windyApiKeyLength} å­—ç¬¦)\n`;
                        message += `æ­£å¸¸çš„ Windy API Key åº”è¯¥æ˜¯è¾ƒé•¿çš„å­—ç¬¦ä¸²\n`;
                        resultType = 'warning';
                    } else {
                        message += `\nâœ… WINDY_API_KEY ç¯å¢ƒå˜é‡é…ç½®æ­£å¸¸\n`;
                        message += `å¦‚æœä»ç„¶æ— æ³•è°ƒç”¨APIï¼Œé—®é¢˜å¯èƒ½åœ¨äº:\n`;
                        message += `1. API Key æ— æ•ˆæˆ–è¢«ç¦ç”¨\n`;
                        message += `2. Windy API æœåŠ¡å™¨è¿æ¥é—®é¢˜\n`;
                        message += `3. API è¯·æ±‚æ ¼å¼é—®é¢˜\n`;
                    }
                    
                    log('env-result', message, resultType);
                } else {
                    log('env-result', `ç¯å¢ƒæµ‹è¯•å¤±è´¥:\n${data.error}\n${data.stack}`, 'error');
                }
                
            } catch (error) {
                console.error('ç¯å¢ƒæµ‹è¯•å‡ºé”™:', error);
                log('env-result', `ç¯å¢ƒæµ‹è¯•å‡ºé”™:\n${error.message}\n${error.stack}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            testEnvironment();
        });
    </script>
</body>
</html>